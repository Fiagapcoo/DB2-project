{% extends "base.html" %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'payment_details/css/payment_details.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-container">
    <!-- Se√ß√£o de detalhes de compra -->
    <div class="purchase-details">
        <h2>Detalhes de Compra</h2>
        <form class="checkout-form">
            <label>Primeiro Nome</label>
            <input type="text" placeholder="Primeiro Nome">
            
            <label>√öltimo Nome</label>
            <input type="text" placeholder="√öltimo Nome">
            
            <label>Nome da Companhia (opcional)</label>
            <input type="text" placeholder="Nome da Companhia">
            
            <label>Pa√≠s / Regi√£o</label>
            <select id="country" name="country">
                <option value="">Selecione o pa√≠s</option>
            </select>
            
            <label>Morada</label>
            <input type="text" placeholder="Morada">
            
            <label>Cidade</label>
            <input type="text" placeholder="Cidade">
            
            <label>C√≥digo-postal</label>
            <input type="text" placeholder="C√≥digo-postal">
            
            <label>N√∫mero de Telem√≥vel</label>
            <input type="text" placeholder="N√∫mero de Telem√≥vel">
            
            <label>Email</label>
            <input type="email" placeholder="Email">
            
            <label>Informa√ß√£o Adicional</label>
            <textarea placeholder="Informa√ß√£o Adicional"></textarea>
        </form>
    </div>

    <!-- Se√ß√£o de resumo do pedido -->
    <div class="order-summary">
        <h2>Resumo do Pedido</h2>
        <div id="order-items">
            <p>Carregando produtos...</p>
        </div>

        <div class="order-subtotal">
            <p>Subtotal</p>
            <span id="subtotal-price">‚Ç¨0.00</span>
        </div>
        <div class="order-total">
            <p>Total</p>
            <span class="total-price" id="total-price">‚Ç¨0.00</span>
        </div>

        <!-- Op√ß√µes de pagamento -->
        <div class="payment-options">
            <input type="radio" id="bank_transfer" name="payment" checked>
            <label for="bank_transfer"><strong>Transfer√™ncia Banc√°ria Direta</strong></label>
            <p class="descricao">Fa√ßa o seu pagamento banc√°rio direto. Ter√° de preencher os dados de modo a garantir o sucesso na sua entrega do produto</p>

            <input type="radio" id="cash_on_delivery" name="payment">
            <label for="cash_on_delivery"><strong>Pagar na Entrega</strong></label>
        </div>

        <!-- Pol√≠tica de privacidade -->
        <p class="privacy-policy">Os seus dados pessoais ser√£o usados de maneira a garantirmos a efici√™ncia na entrega dos produtos.
                                     Poder√° aceder √†s nossas pol√≠ticas de privacidade clicando <a href="#">aqui</a></p>

        <!-- Bot√£o de pedido -->
        <button type="submit" class="order-button" id="order-button" disabled>Fazer pedido</button>
    </div>
</div>

<script>

    function getCartFromCookies() {
        const cookies = document.cookie.split('; ').find(row => row.startsWith('cart='));
        if (!cookies) return {};

        try {
            let rawCart = decodeURIComponent(cookies.split('=')[1])
                .replace(/\\054/g, ',')
                .replace(/\\"/g, '"')
                .replace(/^"|"$/g, '');

            return JSON.parse(rawCart);
        } catch (e) {
            console.error("‚ùå Erro ao interpretar JSON do carrinho:", e);
            return {};
        }
    }

    // üî• Atualiza o resumo do pedido dinamicamente
    function updateOrderSummary() {
        let cart = getCartFromCookies();
        let productIds = Object.keys(cart);

        let orderItemsContainer = document.getElementById("order-items");
        let subtotalElement = document.getElementById("subtotal-price");
        let totalElement = document.getElementById("total-price");
        let orderButton = document.getElementById("order-button");

        if (productIds.length === 0) {
            orderItemsContainer.innerHTML = "<p>Seu carrinho est√° vazio. üõçÔ∏è</p>";
            subtotalElement.innerText = "‚Ç¨0.00";
            totalElement.innerText = "‚Ç¨0.00";
            orderButton.disabled = true;
            return;
        }

        fetch(`/get-cart-items/?ids=${productIds.join(',')}`)
            .then(response => response.json())
            .then(data => {
                let subtotal = 0;
                orderItemsContainer.innerHTML = "";

                data.products.forEach(product => {
                    let quantity = cart[product.productid] || 1;
                    let productTotal = product.final_price * quantity;
                    subtotal += productTotal;

                    let itemHTML = `
                        <div class="order-item">
                            <p>${product.name} &nbsp; x ${quantity}</p>
                            <span>‚Ç¨${productTotal.toFixed(2)}</span>
                        </div>
                    `;
                    orderItemsContainer.innerHTML += itemHTML;
                });

                subtotalElement.innerText = `‚Ç¨${subtotal.toFixed(2)}`;
                totalElement.innerText = `‚Ç¨${subtotal.toFixed(2)}`;
                orderButton.disabled = false;
            })
            .catch(error => {
                console.error("Erro ao carregar os produtos:", error);
                orderItemsContainer.innerHTML = "<p>Erro ao carregar os itens do pedido.</p>";
            });
    }

// Fun√ß√£o para buscar os pa√≠ses da API
async function loadCountries() {
    const response = await fetch('https://restcountries.com/v3.1/all');
    const countries = await response.json();

    const select = document.getElementById('country');
    countries.forEach(country => {
        const option = document.createElement('option'); 
        
        
        const countryName = country.translations.por ? country.translations.por.common : country.name.common;
        
        option.value = country.cca2; 
        option.textContent = countryName; 
        select.appendChild(option); 
    });
}


window.onload = function() {
    loadCountries();
    updateOrderSummary();
};
</script>

{% endblock %}
